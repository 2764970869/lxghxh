<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="./resource/source/lxghxh.svg">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dear Diary</title>
    <script src="./resource/source/3.4.16.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#EC4899',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        dark: '#1E293B',
                        light: '#F8F9FC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .toolbar-btn {
                @apply px-3 py-1.5 rounded-md text-white transition-all duration-200 hover:shadow-md hover:scale-105 active:scale-95;
            }
            .action-btn {
                @apply px-4 py-2 rounded-lg text-white transition-all duration-200 hover:shadow-md hover:scale-105 active:scale-95;
            }
            .editor-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary;
            }
            .animate-fadeOut {
                animation: fadeOut 3s forwards;
            }
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            90% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-20px);
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen p-4 md:p-8 font-inter">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg overflow-hidden">
        <!-- å¤´éƒ¨ -->
        <header class="bg-gradient-to-r from-primary to-blue-600 text-white p-6">
            <h1 class="text-3xl font-bold flex items-center">
                <span class="mr-2"></span>Dear Diary
            </h1>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="p-6">
            <!-- æ—¥æœŸé€‰æ‹©å’Œå¯¼èˆª -->
            <div class="mb-6 flex flex-col sm:flex-row gap-4">
                <div class="flex-grow">
                    <input type="date" id="date"
                        class="w-full px-4 py-2.5 rounded-lg border border-gray-300 editor-focus">
                </div>

                <div class="flex items-center">
                    <span id="weekDayDisplay"
                        class="px-4 py-2.5 rounded-lg border border-gray-300 bg-white text-gray-700">
                        è¯·é€‰æ‹©æ—¥æœŸ
                    </span>
                </div>

                <div class="flex-grow sm:flex-grow-0">
                    <div class="flex gap-2">
                        <input type="text" id="dateSearch" autocomplete="off" placeholder="è¾“å…¥æ—¥æœŸ (YYYYMMDD)"
                            class="flex-grow px-4 py-2.5 rounded-lg border border-gray-300 editor-focus">
                        <button id="searchBtn" class="action-btn bg-primary">
                            æœç´¢
                        </button>
                    </div>
                </div>
            </div>

            <!-- å·¥å…·æ  -->
            <div class="mb-4 flex flex-wrap gap-2">
                <button onclick="execCommand('bold')" class="toolbar-btn bg-primary">
                    B
                </button>
                <button onclick="execCommand('italic')" class="toolbar-btn bg-primary">
                    I
                </button>
                <button onclick="execCommand('underline')" class="toolbar-btn bg-primary">
                    U
                </button>

                <div class="inline-flex items-center gap-2 border border-gray-300 rounded-lg p-1 bg-white">
                    <input type="color" id="colorPicker" class="h-9 w-11 border-none cursor-pointer rounded-md">
                    <button onclick="applyTextColor()" class="toolbar-btn bg-primary text-sm">
                        åº”ç”¨
                    </button>
                </div>

                <button onclick="insertDialog('å¥³æœ‹å‹')" class="toolbar-btn bg-secondary">
                    GF
                </button>
                <button onclick="insertDialog('ç”·æœ‹å‹')" class="toolbar-btn bg-blue-500">
                    BF
                </button>

                <button onclick="undoAction()" class="toolbar-btn bg-gray-500">
                    â†©ï¸
                </button>

                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                <button onclick="document.getElementById('imageUpload').click()" class="toolbar-btn bg-warning">
                    æ’å…¥å›¾ç‰‡
                </button>

                <input type="file" id="videoUpload" accept="video/*" style="display: none;">
                <button onclick="document.getElementById('videoUpload').click()" class="toolbar-btn bg-success">
                    æ’å…¥è§†é¢‘
                </button>
            </div>

            <!-- ç¼–è¾‘å™¨ -->
            <div class="mb-6">
                <div id="editor" contenteditable="true"
                    class="min-h-[300px] p-5 border-2 border-gray-200 rounded-xl editor-focus transition-all duration-200"
                    placeholder="åœ¨æ­¤è¾“å…¥å†…å®¹..." onkeydown="handleKeyDown(event)"></div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="flex flex-wrap gap-3 mt-6">
                <button onclick="saveEntry()" class="action-btn bg-success">
                    ğŸ’¾ä¿å­˜è®°å½•
                </button>
                <button id="downloadBtn" onclick="saveFile()" class="action-btn bg-purple-500">
                    â¬‡ï¸ä¸‹è½½æ–‡ä»¶
                </button>

                <button id="prevDay" class="action-btn bg-primary flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7">
                        </path>
                    </svg>ä¸Šä¸€å¤©
                </button>
                <button id="nextDay" class="action-btn bg-primary flex items-center">
                    åä¸€å¤©
                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>

                <button onclick="redirectToAnotherPage()" class="action-btn bg-secondary">
                    Our Memory
                </button>
            </div>

            <!-- ä»£ç é¢„è§ˆ -->
            <div class="mt-8 bg-gray-50 rounded-xl p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    ä»£ç é¢„è§ˆ
                </h2>
                <pre id="generatedCode" class="bg-gray-100 p-4 rounded-lg overflow-x-auto text-sm font-mono"></pre>
            </div>
        </main>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨
        let newMessages = {};
        let savedDirectoryHandle = null;
		
		    let undoStack = [];
    let redoStack = [];
    const editor = document.getElementById('editor');


        // åˆå§‹åŒ–åŠ è½½
        function init() {
		        editor.innerHTML = '';  // æ¸…ç©ºåˆå§‹å†…å®¹
        undoStack.push(editor.innerHTML);
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            loadEntryForDate();
            document.getElementById('date').addEventListener('change', loadEntryForDate);

            // åˆå§‹åŒ–æ—¥æœŸæœç´¢åŠŸèƒ½
            document.getElementById('searchBtn').addEventListener('click', searchDate);
            document.getElementById('dateSearch').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchDate();
            });

            // åˆå§‹åŒ–ä¸Šä¸€å¤©/ä¸‹ä¸€å¤©æŒ‰é’®
            document.getElementById('prevDay').addEventListener('click', () => navigateDate(-1));
            document.getElementById('nextDay').addEventListener('click', () => navigateDate(1));

            // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
            document.getElementById('imageUpload').addEventListener('change', insertImage);
            document.getElementById('videoUpload').addEventListener('change', insertVideo);

            // æ›´æ–°æ˜ŸæœŸæ˜¾ç¤º
            updateWeekDayDisplay();
        }

        // æœç´¢æ—¥æœŸåŠŸèƒ½
        function searchDate() {
            const input = document.getElementById('dateSearch').value.trim();
            const dateRegex = /^\d{8}$/;

            if (!dateRegex.test(input)) {
                showAlert('è¯·è¾“å…¥æ­£ç¡®çš„æ—¥æœŸæ ¼å¼ (YYYYMMDD)', true);
                return;
            }

            const year = input.substring(0, 4);
            const month = input.substring(4, 6);
            const day = input.substring(6, 8);
            const formattedDate = `${year}-${month}-${day}`;

            const date = new Date(formattedDate);
            if (isNaN(date.getTime())) {
                showAlert('è¾“å…¥çš„æ—¥æœŸæ— æ•ˆ', true);
                return;
            }

            document.getElementById('date').value = formattedDate;
            updateWeekDayDisplay();
            loadEntryForDate();
            showAlert(`å·²åˆ‡æ¢åˆ° ${year}å¹´${month}æœˆ${day}æ—¥`);
        }

        // å¯¼èˆªåˆ°å‰ä¸€å¤©æˆ–åä¸€å¤©
        function navigateDate(days) {
            const date = new Date(document.getElementById('date').value || new Date());
            date.setDate(date.getDate() + days);
            document.getElementById('date').value = formatDate(date);
            updateWeekDayDisplay();
            loadEntryForDate();
            showAlert(`åˆ‡æ¢ä¸º${days > 0 ? 'å' : 'å‰'}ä¸€å¤©æ—¥æœŸï¼š${document.getElementById('date').value}`);
        }

        // åŠ è½½æ—¥è®°å†…å®¹
        async function loadEntryForDate() {
            const dateInput = document.getElementById('date');
            const inputDate = dateInput.value;
            const [year, month, day] = inputDate.split('-');
            const filename = `./message/message_${year}.js`;
            const dateKey = inputDate.replace(/-/g, '');

            let oldMessages = {};
            try {
                await loadScript(filename);
            } catch (err) {
                console.log("æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶");
            }

            if (typeof window[`messages_${year}`] === 'undefined') {
                oldMessages = {};
            } else {
                for (const [key, value] of Object.entries(window[`messages_${year}`])) {
                    if (key.startsWith(year)) {
                        oldMessages[key] = value;
                    }
                }
            }

            const newMessagesInYear = {};
            for (const [key, value] of Object.entries(newMessages)) {
                if (key.startsWith(year)) {
                    newMessagesInYear[key] = value;
                }
            }

            const mergedMessages = { ...oldMessages, ...newMessagesInYear };
            let content = '';
            if (mergedMessages && mergedMessages[dateKey]) {
                content = mergedMessages[dateKey]
                    .replace(/\\n/g, '\n')
                    .replace(/\\'/g, "'")
                    .replace(/\\\\/g, '\\')
					.replace(/HL/g, 'HL<br>');
            }
            document.getElementById('editor').innerHTML = content;
        }

        // ä¿å­˜è®°å½•
        function saveEntry() {
            const dateInput = document.getElementById('date').value;
            const date = dateInput.replace(/-/g, '');
            const content = document.getElementById('editor').innerHTML;

            if (!/^\d{8}$/.test(date)) {
                showAlert('æ—¥æœŸæ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨YYYY-MM-DDæ ¼å¼', true);
                return;
            }

            if (!content.trim()) {
                showAlert('å†…å®¹ä¸èƒ½ä¸ºç©º', true);
                return;
            }

            newMessages[date] = content;
            showAlert('è®°å½•å·²ä¿å­˜');
            generateCode();
        }

        // ç”Ÿæˆä»£ç é¢„è§ˆ
        function generateCode() {
            const dateInput = document.getElementById('date');
            const inputDate = dateInput.value;
            const [year, month, day] = inputDate.split('-');
            let code = `window.messages_${year} = {\n`;
            for (const [date, html] of Object.entries(newMessages)) {
                let cleanedHtml = html.replace(/<div>/g, '').replace(/<\/div>/g, '').replace(/<br>/g, '').replace(/"(.*?\.(png|jpg|mp4|heic|mp4|jpeg))"HL/g, '"$1"');
                const escaped = cleanedHtml
                    .replace(/\\/g, '\\\\')
                    .replace(/'/g, "\\'")
                    .replace(/\n/g, '\\n');
                code += `    '${date}': '${escaped}',\n`;
            }
            document.getElementById('generatedCode').textContent = code + '};';
        }

        // åŠ¨æ€åŠ è½½ JS æ–‡ä»¶
        function loadScript(filename) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = filename;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error(`failed to load ${filename}`));
                document.head.appendChild(script);
            });
        }

        // ä¿å­˜æ–‡ä»¶
        async function saveFile() {
            const dateInput = document.getElementById('date');
            const inputDate = dateInput.value;
            const [year, month, day] = inputDate.split('-');
            const dateKey = `${year}${month}${day}`;
            const filename = `./message/message_${year}.js`;
            const newFileName = `message_${year}.js`;

            const button = document.getElementById("downloadBtn");
            button.disabled = true;
            button.textContent = "æ­£åœ¨ä¸‹è½½...";

            let oldMessages = {};

            try {
                await loadScript(filename);
            } catch (err) {
                console.log("æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶");
            }

            if (typeof window[`messages_${year}`] === 'undefined') {
                oldMessages = {};
            } else {
                for (const [key, value] of Object.entries(window[`messages_${year}`])) {
                    if (key.startsWith(year)) {
                        oldMessages[key] = value;
                    }
                }
            }

            const newMessagesInYear = {};
            for (const [key, value] of Object.entries(newMessages)) {
                if (key.startsWith(year)) {
                    newMessagesInYear[key] = value;
                }
            }

            const mergedMessages = { ...oldMessages, ...newMessagesInYear };

            if (Object.keys(mergedMessages).length === 0) {
                showAlert("æ²¡æœ‰æ•°æ®å¯ä»¥ä¿å­˜");
                return;
            }

            let content = `window.messages_${year} = {\n`;
            for (const [key, html] of Object.entries(mergedMessages)) {
                let cleanedHtml = html
                    .replace(/<div>/g, '')
                    .replace(/<\/div>/g, '')
                    .replace(/<br>/g, '')
                    .replace(/"(.*?\.(png|jpg|mp4|heic|jpeg))"HL/g, '"$1"')
                    .replace(/\\/g, '\\\\')
                    .replace(/'/g, "\\'")
                    .replace(/\n/g, '\\n');

                content += `    '${key}': '${cleanedHtml}',\n`;
            }
            content += '};';

            if (!savedDirectoryHandle) {
                try {
                    savedDirectoryHandle = await window.showDirectoryPicker();
                } catch (err) {
                    console.error('ç›®å½•é€‰æ‹©å¤±è´¥:', err);
                    showAlert('è¯·é€‰æ‹©ä¿å­˜ç›®å½•');
                    button.disabled = false;
                    button.textContent = "â¬‡ï¸ ä¸‹è½½æ–‡ä»¶";
                    return;
                }
            } else {
                showAlert('æ–‡ä»¶æ­£åœ¨ä¿å­˜ä¸­ã€‚');
            }

            try {
                const fileHandle = await savedDirectoryHandle.getFileHandle(newFileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(content);
                await writable.close();
                showAlert(`æ–‡ä»¶å·²ä¿å­˜åˆ°ï¼š${savedDirectoryHandle.name}`);
            } catch (err) {
                console.error('ä¿å­˜å¤±è´¥:', err);
                showAlert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™');
            } finally {
                button.disabled = false;
                button.textContent = "â¬‡ï¸ ä¸‹è½½æ–‡ä»¶";
            }
        }

        // æ’å…¥å¯¹è¯
        function insertDialog(role) {
            const text = `${role}ï¼š""ã€‚`;
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                const textNode = document.createTextNode(text);
                range.insertNode(textNode);
                const newRange = document.createRange();
                newRange.setStart(textNode, text.length - 2);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
            document.getElementById('editor').focus();
			saveState(); // åœ¨æœ€åæ·»åŠ çŠ¶æ€ä¿å­˜
        }

        // æ˜¾ç¤ºæç¤º
        function showAlert(message, isError = false) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-6 right-6 px-4 py-3 rounded-lg shadow-lg animate-fadeOut z-50';
            alertDiv.style.backgroundColor = isError ? '#EF4444' : '#10B981';
            alertDiv.style.color = 'white';
            alertDiv.innerHTML = `<i class="bi-${isError ? 'exclamation-circle mr-2' : 'check-circle mr-2'}"></i>${message}`;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        // åº”ç”¨æ–‡æœ¬é¢œè‰²
        function applyTextColor() {
            const color = document.getElementById('colorPicker').value;
            document.execCommand('styleWithCSS', true);
            document.execCommand('foreColor', false, color);
            showAlert(`å·²åº”ç”¨é¢œè‰²ï¼š${color}`);
        }

        // å¤„ç†é”®ç›˜äº‹ä»¶
        function handleKeyDown(event) {
		
			 if ((event.ctrlKey || event.metaKey) && event.key === 'z') {
            event.preventDefault();
            undoAction();
        }
		
            if (event.key === 'Enter') {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const brText = document.createTextNode("HL");
                    range.insertNode(brText);
                    const newRange = document.createRange();
                    newRange.setStartAfter(brText);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
            }
        }

        // æ’å…¥å›¾ç‰‡
        function insertImage() {
            const fileInput = document.getElementById('imageUpload');
            const file = fileInput.files[0];
            if (file) {
                const dateValue = document.getElementById('date').value;
                const yearMonth = dateValue.replace(/-/g, '').substring(0, 6);
                const pathText = `"./resource/${yearMonth}/${file.name}"`;
                const textNode = document.createTextNode(pathText);
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(textNode);
                    const newRange = new Range();
                    newRange.setStartAfter(textNode);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
                fileInput.value = '';
            }
			saveState(); // åœ¨æœ€åæ·»åŠ çŠ¶æ€ä¿å­˜
        }

        // æ’å…¥è§†é¢‘
        function insertVideo() {
            const fileInput = document.getElementById('videoUpload');
            const file = fileInput.files[0];
            if (file) {
                const dateValue = document.getElementById('date').value;
                const yearMonth = dateValue.replace(/-/g, '').substring(0, 6);
                const pathText = `"./resource/${yearMonth}/${file.name}"`;
                const textNode = document.createTextNode(pathText);
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    range.insertNode(textNode);
                    const newRange = new Range();
                    newRange.setStartAfter(textNode);
                    newRange.collapse(true);
                    selection.removeAllRanges();
                    selection.addRange(newRange);
                }
                fileInput.value = '';
            }
			saveState(); // åœ¨æœ€åæ·»åŠ çŠ¶æ€ä¿å­˜
        }

        // æ‰§è¡Œå‘½ä»¤
       // function execCommand(command) {
      //      document.execCommand(command);
      //      document.getElementById('editor').focus();
    //    }
		
		    function execCommand(command) {
        document.execCommand(command);
        saveState(); // åœ¨å‘½ä»¤æ‰§è¡Œåä¿å­˜çŠ¶æ€
    }
		
		    // æ–°å¢çŠ¶æ€ä¿å­˜å‡½æ•°
    function saveState() {
        const currentHTML = editor.innerHTML;
        if (undoStack.length === 0 || undoStack[undoStack.length - 1] !== currentHTML) {
            undoStack.push(currentHTML);
            redoStack = [];
            // é™åˆ¶æœ€å¤§æ’¤é”€æ­¥æ•°ï¼ˆå¯é€‰ï¼‰
            if (undoStack.length > 100) undoStack.shift();
        }
    }

    // ä¿®æ”¹åçš„æ’¤é”€å‡½æ•°
    function undoAction() {
        if (undoStack.length > 1) {
            // ä¿å­˜å½“å‰çŠ¶æ€åˆ°é‡åšæ ˆ
            const currentState = undoStack.pop();
            redoStack.push(currentState);
            
            // æ¢å¤å‰ä¸€ä¸ªçŠ¶æ€ï¼ˆé¿å…è§¦å‘äº‹ä»¶ï¼‰
            editor.removeEventListener('input', saveState);
            editor.innerHTML = undoStack[undoStack.length - 1];
            editor.addEventListener('input', saveState);
        }
    }
	
	
    // åœ¨ç¼–è¾‘å™¨æ·»åŠ è¾“å…¥ç›‘å¬
    editor.addEventListener('input', saveState);

        // é‡å®šå‘åˆ°å¦ä¸€ä¸ªé¡µé¢
        function redirectToAnotherPage() {
            window.location.href = './loveDaily.html';
        }

        // æ›´æ–°æ˜ŸæœŸæ˜¾ç¤º
        function updateWeekDayDisplay() {
            const dateValue = document.getElementById('date').value;
            if (!dateValue) {
                document.getElementById('weekDayDisplay').textContent = 'è¯·é€‰æ‹©æ—¥æœŸ';
                return;
            }

            const [year, month, day] = dateValue.split('-').map(Number);
            const date = new Date(year, month - 1, day);
            const options = { weekday: 'long' };
            const weekDay = date.toLocaleDateString('zh-CN', options);
            document.getElementById('weekDayDisplay').textContent = weekDay;
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            return [
                date.getFullYear(),
                String(date.getMonth() + 1).padStart(2, '0'),
                String(date.getDate()).padStart(2, '0')
            ].join('-');
        }

        // åˆå§‹åŒ–æ‰§è¡Œ
        init();
    </script>
</body>

</html>